Tournament scoring scripts for the Dungeon Crawl tournament (DCSS)
==================================================================

Rules Template
--------------

Tourney rules are described in templates/index.mako. When updating
index.mako, run update_index.py to generate the html output.

Configuring scripts
-------------------

The version, dates, etc used to get the game data are defined in loaddb.py.
Some paths and URLs are defined in crawl_utils.py: see LOCAL_TEST, WEB_BASE,
and SCORE_FILE_DIR.

Running scripts
---------------

To run loaddb.py:

1. Make sure MySQL is up and running, with a db 'tournament' with access to
   the user 'crawl' with no pw.

2. mysql -ucrawl -p tournament < database.sql will (re)create the tables,
   discarding any existing data.

3. python loaddb.py will update the database with logfile and milestone
   records that are not already in the db. If interrupted, it can continue
   where it left off.

   python taildb.py will start a daemon to update the db continuously from
   the logfile and milestones. taildb is otherwise identical in behaviour
   to loaddb.py.

Testing scripts
---------------

If USE_TEST is set to True in test_data.py, then the version, dates, etc in
that file will be used when running the scripts. Also, the rules page will
not have toplinks on it (useful when announcing the tournament if you are
still testing things).
   
Nemelex' Choice
---------------

Currently Nemelex' Choice combo selection happens automatically and does not
require Sequell's database. If NEMELEX_USE_LIST is set to True in nemelex.py,
then the combos will all be chosen from the file nem_eligible.txt. Otherwise,
the first combo will be chosen from this file and later combos will be chosen
from those with the lowest high score thus far in the tournament.

Other things
------------

* You will probably want to set up a cronjob to grab rcfiles from the various
  servers and place them in the directories listed in CRAWLRC_DIRECTORY_LIST
  in loaddb.py.

* When running these scripts on one of the public servers, you will want to
  link the various logfiles on that server into the current directory.
  For the 0.9 tournament, ./link-setup was used for this (on CAO).

* The file tourney-guide.txt contains a checklist of all the steps involved in
  organizing and running a tournament each new version.
  

John's cheatsheet on setting up a new branch:

start up mysql:
crawl-dev@www:~/tourney/dbro$ mysql -u root -p
Enter mysql password: 

create a new DB that will be used in loaddb.py

mysql> CREATE DATABASE tournamentdbro;
Query OK, 1 row affected (0.00 sec)

mysql> USE tournamentdbro;
Database changed
mysql> GRANT ALL PRIVILEGES ON tournamentdbro.* To 'crawl'@'localhost';
Query OK, 0 rows affected (0.01 sec)

mysql> FLUSH PRIVILEGES;
Query OK, 0 rows affected (0.00 sec)

mysql> exit

you have to create a user named crawl without a password, but I can't remember how to do it.

run this command to reset the db

crawl-dev@www:~/tourney/dbro$ mysql -ucrawl -p tournamentdbro < database.sql

edit the whitelist and make other required changes (see https://github.com/jmbjr/dcss_tourney/commit/0031de903075ab459ebde894f91a1415331eaa77 for most of the stuff you should change)
(requires pointing to the correct sources for scores/stones/logs)

to initialize the db:
run $ python loaddb.py

then to continuously update the data:
run $ python taildb.py

(note, to make any changes to the db, eg if you add a new challenge, new person on the whitelist, or new sources, you will need to kill taildb.py, blank out the db again, run loaddb.py, and then taildb.py again)
